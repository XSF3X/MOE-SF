<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ملف إنجاز المعلم - نظام الشواهد</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- سيتم إدراج CSS هنا من css.txt عبر المولّد -->

</head>
<body>

<div class="page">

<header>
  <div class="app-title">
    <h1>ملف إنجاز المعلم - نظام الشواهد</h1>
    <div class="app-subtitle">
      رفع شواهد المعايير، إنشاء صفحات HTML تلقائيًا على GitHub، وتوليد QR داخل ملف الإنجاز.
    </div>
    <div class="teacher-label">
      المستخدم الحالي: <span id="teacher-username"></span>
      <span id="github-status" style="margin-right:6px;font-size:10px;color:#9ca3af;"></span>
    </div>
  </div>

  <div class="header-spacer"></div>

  <button class="btn btn-ghost" id="github-btn" type="button">إعداد GitHub</button>
  <button class="btn btn-ghost" id="admin-btn" style="display:none;" type="button">لوحة التحكم</button>
  <button class="btn btn-ghost" type="button" onclick="logout()">تسجيل الخروج</button>
  <button class="btn btn-primary" type="button" id="btn-generate">توليد ملف الإنجاز النهائي</button>
</header>

<main>
  <section class="grid" id="criteria-grid"></section>

  <div class="footer-actions">
    <span class="progress" id="global-status">جارٍ تحميل القالب template.pptx...</span>
  </div>

  <section class="qr-preview" id="qr-section" style="display:none;">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <strong>معاينة رموز QR لكل معيار</strong>
      <span class="small">تم رفع صفحات HTML على GitHub وربط كل معيار برابط خاص.</span>
    </div>
    <div class="qr-grid" id="qr-grid"></div>
  </section>
</main>

<!-- اسم المعلم -->
<div id="teacherPopup">
  <div class="popup-inner">
    <h3>إدخال اسم المعلم</h3>
    <p>أدخل اسم المعلم، ثم سيتم إنشاء الصفحات وملف الإنجاز تلقائيًا.</p>
    <input id="teacherNameInput" class="popup-input" style="direction:rtl;" placeholder="مثال: سعود الشريف">
    <div class="popup-buttons">
      <button class="btn-confirm" onclick="confirmTeacherName()">متابعة</button>
      <button class="btn-cancel" onclick="closeTeacherPopup()">إلغاء</button>
    </div>
  </div>
</div>

<!-- إعداد GitHub -->
<div id="githubPopup">
  <div class="popup-inner">
    <h3>إعداد GitHub Token</h3>
    <p>أدخل Personal Access Token الذي لديه صلاحية الكتابة على المستودع MOE-SF فقط.</p>
    <input id="githubTokenInput" class="popup-input" placeholder="ghp_..." autocomplete="off">
    <div class="popup-buttons">
      <button class="btn-confirm" onclick="saveGithubToken()">حفظ</button>
      <button class="btn-cancel" onclick="closeGithubPopup()">إغلاق</button>
    </div>
  </div>
</div>

<script>

/* ============================
   BASE STYLES
   الخط — اللون — Reset
   ============================ */

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  font-family: "Cairo", sans-serif;
  background: #020617;
  color: #e2e8f0;
  line-height: 1.6;
}

.page {
  width: 100%;
  min-height: 100vh;
  padding: 20px;
}

h1, h2, h3, h4 {
  font-weight: 600;
  margin-bottom: 8px;
}

button {
  cursor: pointer;
  font-family: "Cairo", sans-serif;
  transition: 0.15s;
}

input {
  font-family: "Cairo", sans-serif;
}

/* روابط */
a {
  color: #38bdf8;
  text-decoration: none;
}
a:hover {
  color: #7dd3fc;
}
/* ============================
   LAYOUT STYLES
   الهيدر — الشبكة — الخطوط
   ============================ */

/* الهيدر */
header {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.app-title h1 {
  font-size: 26px;
  margin-bottom: 4px;
  color: #f1f5f9;
}

.app-subtitle {
  font-size: 14px;
  color: #94a3b8;
}

.teacher-label {
  margin-top: 5px;
  font-size: 12px;
  color: #cbd5e1;
}

.header-spacer {
  flex: 1;
}

/* الأزرار */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: 38px;
  padding: 0 16px;
  border-radius: 8px;
  border: none;
  font-size: 14px;
  font-weight: 500;
}

.btn-primary {
  background: #0ea5e9;
  color: #fff;
}
.btn-primary:hover {
  background: #0284c7;
}

.btn-ghost {
  background: rgba(255,255,255,0.05);
  color: #e2e8f0;
}
.btn-ghost:hover {
  background: rgba(255,255,255,0.1);
}

/* الشبكة */
.grid {
  display: grid;
  gap: 16px;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  margin-top: 20px;
}

/* كارد */
.card {
  background: #0f172a;
  border: 1px solid #1e293b;
  border-radius: 10px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-height: 180px;
  transition: 0.2s;
}

.card:hover {
  border-color: #2dd4bf;
  box-shadow: 0 0 8px rgba(45,212,191,0.25);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.card-title {
  font-size: 18px;
  font-weight: 600;
  color: #f8fafc;
}

.card-subtitle {
  font-size: 13px;
  color: #94a3b8;
}

.card-count {
  font-size: 12px;
  color: #22d3ee;
}

.card-actions {
  display: flex;
  gap: 10px;
}

.card-status {
  font-size: 12px;
  color: #cbd5e1;
}

/* أزرار الكارد */
.file-input {
  display: none;
}

/* الـ Footer */
.footer-actions {
  margin-top: 20px;
  font-size: 13px;
  color: #aeb8c5;
}

/* QR grid */
.qr-grid {
  margin-top: 20px;
  display: grid;
  gap: 20px;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
}

.qr-item {
  padding: 14px;
  background: #0f172a;
  border: 1px solid #1e293b;
  text-align: center;
  border-radius: 8px;
}

.qr-item img {
  width: 140px;
  margin: 6px auto;
}

/* نص صغير */
.small {
  font-size: 10px;
  color: #94a3b8;
  overflow-wrap: anywhere;
}

/* RESPONSIVE */
@media(max-width: 480px) {
  .btn {
    width: 100%;
    margin-top: 8px;
  }

  header {
    flex-direction: column;
    align-items: flex-start;
  }

  .header-spacer {
    display: none;
  }
}
/* ============================
   COMPONENTS STYLES
   Popups — Buttons — Overlays
   ============================ */

/* ====== Popup Overlay ====== */
#teacherPopup,
#githubPopup {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.25s ease-out;
}

/* ====== Popup Inner ====== */
.popup-inner {
  background: #0f172a;
  border: 1px solid #1e293b;
  padding: 24px;
  width: 90%;
  max-width: 420px;
  border-radius: 12px;
  box-shadow: 0 0 12px rgba(0,0,0,0.35);
  animation: slideDown 0.25s ease-out;
}

.popup-inner h3 {
  font-size: 20px;
  color: #f8fafc;
  margin-bottom: 10px;
}

.popup-inner p {
  font-size: 13px;
  color: #94a3b8;
  margin-bottom: 16px;
}

/* ====== Popup Input ====== */
.popup-input {
  width: 100%;
  height: 42px;
  padding: 0 12px;
  border-radius: 8px;
  border: 1px solid #334155;
  background: #1e293b;
  color: #e2e8f0;
  font-size: 14px;
  outline: none;
  transition: 0.2s;
}

.popup-input:focus {
  border-color: #38bdf8;
}

/* ====== Popup Buttons ====== */
.popup-buttons {
  margin-top: 18px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.btn-confirm {
  background: #0ea5e9;
  padding: 10px 16px;
  border-radius: 8px;
  color: #fff;
  border: none;
  font-size: 14px;
  transition: 0.15s;
}

.btn-confirm:hover {
  background: #0284c7;
}

.btn-cancel {
  background: rgba(255,255,255,0.06);
  padding: 10px 16px;
  border-radius: 8px;
  color: #f8fafc;
  border: 1px solid #475569;
  font-size: 14px;
  transition: 0.15s;
}

.btn-cancel:hover {
  background: rgba(255,255,255,0.12);
}

/* ====== Animations ====== */
@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

@keyframes slideDown {
  from { transform: translateY(-15px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}
/* ============================
   THEME / COLORS / EFFECTS
   ============================ */

/* ===== ألوان عامة ===== */
:root {
  --bg-dark:        #020617;
  --bg-card:        #0f172a;
  --bg-card-hover:  #16223a;

  --border-light:   #1e293b;
  --border-strong:  #334155;

  --text-main:      #f8fafc;
  --text-soft:      #e2e8f0;
  --text-muted:     #94a3b8;
  --text-accent:    #22d3ee;

  --accent:         #0ea5e9;
  --accent-hover:   #0284c7;

  --glow-accent:    rgba(14,165,233,0.35);
  --glow-qr:        rgba(45,212,191,0.20);
}

/* ===== تأثيرات عامة ===== */
.card,
.qr-item,
.popup-inner {
  transition: border-color 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
}

/* ===== تأثير hover للكروت ===== */
.card:hover {
  background: var(--bg-card-hover);
  border-color: var(--accent);
  box-shadow: 0 0 12px var(--glow-qr);
}

/* ===== أزرار أساسية ===== */
.btn-primary {
  background: var(--accent);
  color: var(--text-main);
}

.btn-primary:hover {
  background: var(--accent-hover);
}

/* ===== أزرار الشبح ===== */
.btn-ghost {
  background: rgba(255,255,255,0.05);
  color: var(--text-soft);
  border: 1px solid var(--border-light);
}

.btn-ghost:hover {
  background: rgba(255,255,255,0.10);
  border-color: var(--accent);
}

/* ===== تحسين النصوص ===== */
.card-title {
  color: var(--text-main);
}

.card-subtitle {
  color: var(--text-muted);
}

.card-count {
  color: var(--text-accent);
}

/* ===== QR Item ===== */
.qr-item {
  border: 1px solid var(--border-light);
  box-shadow: 0 0 6px rgba(0,0,0,0.25);
}

.qr-item:hover {
  border-color: var(--accent);
  box-shadow: 0 0 12px var(--glow-accent);
}

.qr-item img {
  border-radius: 6px;
}

/* ===== Popups ===== */
.popup-inner {
  border-color: var(--border-light);
  box-shadow: 0 0 16px rgba(0,0,0,0.4);
}

.popup-inner h3 {
  color: var(--text-main);
}

.popup-inner p {
  color: var(--text-muted);
}

/* ===== Confirm Button ===== */
.btn-confirm {
  background: var(--accent);
  color: var(--text-main);
}

.btn-confirm:hover {
  background: var(--accent-hover);
}

/* ===== Cancel Button ===== */
.btn-cancel {
  border-color: var(--border-strong);
  color: var(--text-soft);
}

.btn-cancel:hover {
  background: rgba(255,255,255,0.10);
}

/* ===== خلفيات عامة ===== */
body {
  background: var(--bg-dark);
  color: var(--text-soft);
}

/* ===== تحسين اللمسات النهائية ===== */
header {
  border-bottom: 1px solid rgba(255,255,255,0.06);
  padding-bottom: 10px;
}

.footer-actions {
  margin-top: 22px;
  color: var(--text-muted);
}

/* ===============================
   JS CORE – PART 1
   رفع الصور + بناء صفحات HTML + GitHub API
   =============================== */

/* التحقق من تسجيل الدخول */
(function() {
  const user = localStorage.getItem("loggedInUser");
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  window.CURRENT_USER = user;
})();

/* إعدادات GitHub */
const GITHUB_OWNER   = "XSF3X";
const GITHUB_REPO    = "MOE-SF";
const GITHUB_BRANCH  = "main";
const GITHUB_PAGES_BASE = "https://xsf3x.github.io/MOE-SF";

/* القالب */
const PPTX_TEMPLATE_URL = "static/template_v2.pptx";

/* قائمة المعايير */
const CRITERIA = [
  { id: 1,  title: "المعيار الأول",      subtitle: "أداء الواجبات الوظيفية" },
  { id: 2,  title: "المعيار الثاني",     subtitle: "التفاعل مع المجتمع المهني" },
  { id: 3,  title: "المعيار الثالث",     subtitle: "التفاعل مع أولياء الأمور" },
  { id: 4,  title: "المعيار الرابع",     subtitle: "استراتيجيات التدريس" },
  { id: 5,  title: "المعيار الخامس",     subtitle: "تحسين نتائج المتعلمين" },
  { id: 6,  title: "المعيار السادس",     subtitle: "خطة التعلم" },
  { id: 7,  title: "المعيار السابع",     subtitle: "التقنيات التعليمية" },
  { id: 8,  title: "المعيار الثامن",     subtitle: "تهيئة البيئة التعليمية" },
  { id: 9,  title: "المعيار التاسع",     subtitle: "الإدارة الصفية" },
  { id:10,  title: "المعيار العاشر",     subtitle: "تحليل نتائج المتعلمين" },
  { id:11,  title: "المعيار الحادي عشر", subtitle: "تنوع أساليب التقويم" },
  { id:12,  title: "منجزات أخرى",        subtitle: "منجزات العام الدراسي" }
];

/* الحالة العامة */
const state = {
  pptxBuffer: null,
  criteriaFiles: {},
  albums: {},
  teacherName: "",
  githubToken: localStorage.getItem("githubToken") || ""
};

/* عناصر DOM */
const gridEl = document.getElementById("criteria-grid");
const globalStatusEl = document.getElementById("global-status");
const btnGenerate = document.getElementById("btn-generate");
const qrSection = document.getElementById("qr-section");
const qrGrid = document.getElementById("qr-grid");

/* تحديث حالة GitHub */
function updateGithubStatus() {
  const s = document.getElementById("github-status");
  if (!s) return;
  s.textContent = state.githubToken ? "GitHub Token مضبوط" : "لم يتم إعداد GitHub Token";
}

/* حفظ GitHub Token */
function saveGithubToken() {
  const val = document.getElementById("githubTokenInput").value.trim();
  if (!val) return alert("أدخل Token صالح.");
  state.githubToken = val;
  localStorage.setItem("githubToken", val);
  updateGithubStatus();
  closeGithubPopup();
}

/* Slug لاسم المعلم */
function slugifyTeacher(name) {
  return name.trim().replace(/\s+/g,"-").replace(/[^\w\u0600-\u06FF-]/g,"");
}

/* اسم ملف HTML للمعيار */
function buildHtmlFileName(teacherName, criterionId) {
  const slug = slugifyTeacher(teacherName) || "teacher";
  const idStr = String(criterionId).padStart(2,"0");
  return `albums/${slug}_c${idStr}.html`;
}

/* رابط GitHub Pages النهائي */
function buildHtmlPageUrl(path) {
  return `${GITHUB_PAGES_BASE}/${path}`;
}

/* تحويل ملف → DataURL */
function fileToDataURL(file) {
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror= reject;
    reader.readAsDataURL(file);
  });
}

/* HTML للصفحة */
function buildCriterionHtml({ teacherName, criterion, images }) {
  const safeTeacher = teacherName;
  return `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head><meta charset="UTF-8">
<title>${criterion.title} - ${safeTeacher}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
 body{background:#020617;color:#fff;font-family:Cairo,sans-serif;margin:0;padding:15px}
 h1{margin-bottom:5px;font-size:20px}
 .img-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:15px}
 .img-box{background:#0f172a;padding:8px;border-radius:10px;border:1px solid #334155}
 img{width:100%;border-radius:6px}
</style>
</head>
<body>
<h1>${criterion.title}</h1>
<div>${criterion.subtitle}</div>
<div>المعلم: ${safeTeacher}</div>
<div class="img-grid">
${images.map(x=>`<div class="img-box"><img src="${x}"></div>`).join("")}
</div>
</body>
</html>`;
}

/* رفع HTML إلى GitHub */
async function uploadFileToGitHub(path, content) {
  if (!state.githubToken) throw new Error("GitHub Token غير مضبوط.");

  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(path)}`;
  const headers = {
    "Authorization": `Bearer ${state.githubToken}`,
    "Accept": "application/vnd.github+json"
  };

  let sha = null;
  const getRes = await fetch(url,{headers});
  if (getRes.ok) {
    const j = await getRes.json();
    sha = j.sha;
  }

  const body = {
    message:`update ${path}`,
    content: btoa(unescape(encodeURIComponent(content))),
    branch: GITHUB_BRANCH
  };
  if (sha) body.sha = sha;

  const putRes = await fetch(url,{
    method:"PUT",
    headers,
    body: JSON.stringify(body)
  });

  if (!putRes.ok) {
    const txt = await putRes.text();
    throw new Error(`Upload error: ${txt}`);
  }
}

/* تحميل قالب PPTX */
async function loadTemplate() {
  try {
    const res = await fetch(PPTX_TEMPLATE_URL);
    if (!res.ok) throw new Error("خطأ تحميل القالب");
    state.pptxBuffer = await res.arrayBuffer();
    globalStatusEl.textContent = "القالب جاهز — ارفع الصور ثم اضغط توليد الملف.";
  } catch (e) {
    globalStatusEl.textContent = "تعذر تحميل القالب.";
  }
}

/* بناء البطاقات */
function buildCards() {
  CRITERIA.forEach(c=>{
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.criterionId = c.id;

    const header = document.createElement("div");
    header.className = "card-header";
    header.innerHTML = `<div class="card-title">${c.title}</div>
                        <div id="count-${c.id}" class="card-count">0 صورة</div>`;

    const subtitleEl = document.createElement("div");
    subtitleEl.className = "card-subtitle";
    subtitleEl.textContent = c.subtitle;

    const fileInput = document.createElement("input");
    fileInput.type="file";
    fileInput.multiple=true;
    fileInput.accept="image/*";
    fileInput.className="file-input";
    fileInput.id=`files-${c.id}`;

    const btn = document.createElement("button");
    btn.type="button";
    btn.className="btn btn-ghost";
    btn.textContent="اختيار صور الشواهد";
    btn.onclick=()=>fileInput.click();

    const status = document.createElement("div");
    status.className="card-status";
    status.id=`status-${c.id}`;
    status.textContent="لم يتم اختيار أي صورة.";

    fileInput.onchange=()=>{
      const files=[...fileInput.files];
      state.criteriaFiles[c.id]=files;
      document.getElementById(`count-${c.id}`).textContent=`${files.length} صورة`;
      status.textContent = files.length>0 ?
        "سيتم إنشاء صفحة HTML ورفعها." :
        "لم يتم اختيار أي صورة.";
    };

    const actions=document.createElement("div");
    actions.className="card-actions";
    actions.appendChild(btn);

    card.appendChild(header);
    card.appendChild(subtitleEl);
    card.appendChild(actions);
    card.appendChild(status);
    card.appendChild(fileInput);
    gridEl.appendChild(card);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  updateGithubStatus();
  buildCards();
  loadTemplate();
});

/* ===============================
   JS CORE – PART 2
   QR + PPTX ZIP + Inject + Export
   =============================== */

/* تحويل dataURL → Bytes */
function dataURLToUint8Array(dataURL){
  const b = atob(dataURL.split(",")[1]);
  const arr = new Uint8Array(b.length);
  for (let i=0; i<b.length; i++) arr[i]=b.charCodeAt(i);
  return arr;
}

/* توليد QR كـ DataURL + Binary */
function generateQR(url){
  return new Promise((resolve,reject)=>{
    const box=document.createElement("div");
    box.style.position="absolute";
    box.style.left="-9999px";
    box.style.top="-9999px";
    document.body.appendChild(box);

    const qr=new QRCode(box,{
      text:url,
      width:200,
      height:200,
      correctLevel:QRCode.CorrectLevel.L
    });

    setTimeout(()=>{
      const canvas=box.querySelector("canvas");
      if(!canvas){document.body.removeChild(box);return reject("QR failed");}
      const durl=canvas.toDataURL("image/png");
      const bytes=dataURLToUint8Array(durl);
      document.body.removeChild(box);
      resolve({dataURL:durl,bytes});
    },300);
  });
}

/* حقن اسم المعلم في slide1 */
async function replaceTeacherName(zip,name){
  const p="ppt/slides/slide1.xml";
  if(!zip.file(p)) return;
  let xml=await zip.file(p).async("string");
  xml=xml.replace(/∑/g,name);
  zip.file(p,xml);
}

/* دمج QR داخل ملف PPTX */
async function injectQROnPptx(zip,albums){
  /* إضافة نوع PNG */
  const ctFile=zip.file("[Content_Types].xml");
  if(ctFile){
    let ct=await ctFile.async("string");
    if(!ct.includes('image/png')){
      ct=ct.replace("</Types>",
        '<Default Extension="png" ContentType="image/png"/></Types>');
    }
    zip.file("[Content_Types].xml",ct);
  }

  zip.folder("ppt")?.folder("media") || zip.folder("ppt").folder("media");

  const ids=Object.keys(albums).map(Number).sort((a,b)=>a-b);

  /* أضف صور QR */
  for(const id of ids){
    const name=`qr_${id}.png`;
    albums[id].mediaName=name;
    zip.file(`ppt/media/${name}`,albums[id].qrBinary,{binary:true});
  }

  /* تعديل كل الشرائح */
  const slidePaths=Object.keys(zip.files)
    .filter(x=>x.startsWith("ppt/slides/slide") && x.endsWith(".xml"))
    .sort((a,b)=>{
      const A=parseInt(a.match(/slide(\d+)/)[1],10);
      const B=parseInt(b.match(/slide(\d+)/)[1],10);
      return A-B;
    });

  let ptr=0;

  for(const slidePath of slidePaths){
    let xml=await zip.file(slidePath).async("string");
    const slideBase=slidePath.split("/").pop();
    const relPath=`ppt/slides/_rels/${slideBase}.rels`;

    let rels=zip.file(relPath)?
      await zip.file(relPath).async("string"):
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"></Relationships>`;

    /* احسب آخر rId */
    let maxRid=1;
    const rg=/Id="rId(\d+)"/g;
    let m;
    while((m=rg.exec(rels))!==null){
      const n=parseInt(m[1],10);
      if(n>maxRid) maxRid=n;
    }

    let idx=0, changed=false;

    while(true){
      const start=xml.indexOf("<p:sp",idx);
      if(start===-1) break;
      const end=xml.indexOf("</p:sp>",start);
      if(end===-1) break;

      const block=xml.slice(start,end+7);

      if(block.includes("FF00FF") && ptr<ids.length){
        const id=ids[ptr++];
        const mediaName=albums[id].mediaName;
        const newRid="rId"+(++maxRid);

        /* استبدال الشكل بصورة */
        const repl=
`<p:pic><p:nvPicPr><p:cNvPr id="${1000+id}" name="QR ${id}"/>
<p:cNvPicPr/><p:nvPr/></p:nvPicPr>
<p:blipFill><a:blip r:embed="${newRid}"/>
<a:stretch><a:fillRect/></a:stretch></p:blipFill>
<p:spPr/></p:pic>`;

        xml=xml.slice(0,start)+repl+xml.slice(end+7);

        /* إضافة علاقة */
        rels=rels.replace("</Relationships>",
          `<Relationship Id="${newRid}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="../media/${mediaName}"/></Relationships>`);

        idx=start+repl.length;
        changed=true;
      } else {
        idx=end+7;
      }
    }

    if(changed){
      zip.file(slidePath,xml);
      zip.file(relPath,rels);
    }
  }
}

/* توليد الملف النهائي */
async function generateAndDownload(){
  if(!state.pptxBuffer) return alert("القالب غير جاهز");
  if(!state.githubToken) return alert("أدخل GitHub Token");

  const chosen=CRITERIA.filter(c=>(state.criteriaFiles[c.id]||[]).length>0);
  if(chosen.length===0) return alert("اختر صوراً أولاً.");

  if(!state.teacherName) return alert("أدخل اسم المعلم");

  btnGenerate.disabled=true;
  qrGrid.innerHTML="";
  qrSection.style.display="none";
  state.albums={};

  let i=0;

  for(const crit of chosen){
    i++;
    const status=document.getElementById(`status-${crit.id}`);
    const files=state.criteriaFiles[crit.id]||[];

    status.textContent="معالجة الصور...";
    const durls=[];

    let j=0;
    for(const f of files){
      j++;
      globalStatusEl.textContent=`${crit.title} — صورة ${j}/${files.length}`;
      try{
        const d=await fileToDataURL(f);
        durls.push(d);
      }catch{}
    }

    if(durls.length===0){
      status.textContent="فشل قراءة الصور";
      continue;
    }

    /* بناء HTML */
    const path=buildHtmlFileName(state.teacherName,crit.id);
    const html=buildCriterionHtml({
      teacherName: state.teacherName,
      criterion: crit,
      images: durls
    });

    /* رفع HTML */
    globalStatusEl.textContent=`رفع ${path}...`;
    try{
      await uploadFileToGitHub(path,html);
    }catch(e){
      status.textContent="خطأ رفع HTML";
      continue;
    }

    /* توليد QR */
    const url=buildHtmlPageUrl(path);
    const qr=await generateQR(url);

    state.albums[crit.id]={
      htmlPath:path,
      pageUrl:url,
      qrBinary:qr.bytes,
      qrDataURL:qr.dataURL
    };

    /* إضافة للمعاينة */
    const box=document.createElement("div");
    box.className="qr-item";
    box.innerHTML=
      `<div style="font-size:13px;margin-bottom:4px">${crit.title}</div>
       <img src="${qr.dataURL}">
       <div class="small">${url}</div>`;
    qrGrid.appendChild(box);

    status.textContent="تم رفع HTML وربط QR.";
  }

  /* لو ما فيه أي ملفات ناجحة */
  if(Object.keys(state.albums).length===0){
    globalStatusEl.textContent="لم تنجح العملية";
    btnGenerate.disabled=false;
    return;
  }

  /* تجهيز PPTX */
  globalStatusEl.textContent="دمج QR داخل القالب...";

  const buffer=state.pptxBuffer.slice(0);
  const zip=await JSZip.loadAsync(buffer);

  await replaceTeacherName(zip,state.teacherName);
  await injectQROnPptx(zip,state.albums);

  const blob=await zip.generateAsync({type:"blob"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="ملف_الإنجاز_QR.pptx";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  globalStatusEl.textContent="تم توليد ملف الإنجاز.";
  qrSection.style.display="block";
  btnGenerate.disabled=false;
}

/* Popups */
function openTeacherPopup(){document.getElementById("teacherPopup").style.display="flex";}
function closeTeacherPopup(){document.getElementById("teacherPopup").style.display="none";}
function confirmTeacherName(){
  const val=document.getElementById("teacherNameInput").value.trim();
  if(!val) return alert("أدخل اسم المعلم");
  state.teacherName=val;
  closeTeacherPopup();
  generateAndDownload();
}

document.getElementById("github-btn").onclick=()=>{
  document.getElementById("githubTokenInput").value=state.githubToken;
  document.getElementById("githubPopup").style.display="flex";
};
function closeGithubPopup(){document.getElementById("githubPopup").style.display="none";}


/* تهيئة ��سم المستخدم في الهيدر + زر الأدمن */
const teacherUsernameSpan = document.getElementById("teacher-username");
if (window.CURRENT_USER && teacherUsernameSpan) {
  teacherUsernameSpan.textContent = window.CURRENT_USER;
}

const adminBtn = document.getElementById("admin-btn");
if (adminBtn) {
  adminBtn.style.display = (window.CURRENT_USER === "admin") ? "inline-flex" : "none";
  adminBtn.onclick = () => { window.location.href = "admin.html"; };
}

/* تسجيل خروج */
function logout(){
  localStorage.removeItem("loggedInUser");
  window.location.href = "login.html";
}


/* زر توليد */
btnGenerate.onclick=openTeacherPopup;

</script>

</div> <!-- .page -->

</body>
</html>

