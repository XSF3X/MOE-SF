<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ملف إنجاز المعلم - نظام الشواهد</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

  <style>
    :root {
      --bg-main: #020617;
      --panel: rgba(15,23,42,0.82);
      --panel-soft: rgba(15,23,42,0.7);
      --accent-teal: #14b8a6;
      --accent-green: #16a34a;
      --accent-gold: #facc15;
      --accent-purple: #7c3aed;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: rgba(148,163,184,0.4);
      --radius-lg: 18px;
      --radius-xl: 22px;
      --shadow-strong: 0 22px 60px rgba(15,23,42,0.9);
      --shadow-soft: 0 14px 40px rgba(15,23,42,0.85);
      --transition-fast: 0.18s ease-out;
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      font-family:"Cairo",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      min-height:100vh;
      background:
        radial-gradient(circle at 0 0, #0f766e30, transparent 45%),
        radial-gradient(circle at 100% 0, #7c3aed30, transparent 55%),
        radial-gradient(circle at 0 100%, #16a34a30, transparent 55%),
        radial-gradient(circle at 100% 100%, #facc1535, transparent 55%),
        var(--bg-main);
      color:var(--text-main);
    }

    .page {
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 16px 28px;
    }

    header {
      display:flex;
      align-items:center;
      gap:14px;
      padding:10px 8px 8px;
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(18px);
      background: linear-gradient(to bottom,
        rgba(15,23,42,0.96),
        rgba(15,23,42,0.75),
        transparent
      );
    }

    .app-title {
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .app-title h1 {
      margin:0;
      font-size:18px;
      font-weight:700;
      letter-spacing:0.01em;
    }

    .app-subtitle {
      font-size:12px;
      color:var(--text-muted);
    }

    .teacher-label {
      font-size:11px;
      color:var(--text-muted);
      margin-top:2px;
    }

    .header-spacer { flex:1; }

    .btn {
      border:none;
      padding:7px 14px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
      transition:
        background var(--transition-fast),
        color var(--transition-fast),
        transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    .btn-primary {
      background:linear-gradient(135deg,var(--accent-green),var(--accent-teal));
      color:#022c22;
      font-weight:600;
      box-shadow:0 10px 26px rgba(16,185,129,0.4);
    }
    .btn-primary:hover {
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(16,185,129,0.6);
      filter:brightness(1.04);
    }

    .btn-ghost {
      background:rgba(15,23,42,0.4);
      color:var(--text-main);
      border:1px solid rgba(148,163,184,0.4);
    }
    .btn-ghost:hover {
      background:rgba(15,23,42,0.85);
      border-color:var(--accent-teal);
      transform:translateY(-1px);
    }

    main {
      padding: 14px 2px 4px;
    }

    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:14px;
    }

    .card {
      background:var(--panel);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-soft);
      padding:14px 14px 16px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:150px;
      border:1px solid var(--border-soft);
      position:relative;
      overflow:hidden;
      transition:
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        border-color var(--transition-fast),
        background var(--transition-fast);
    }
    .card::after {
      content:"";
      position:absolute;
      inset-inline-end:-20px;
      inset-block-end:-20px;
      width:90px;
      height:90px;
      background:
        radial-gradient(circle at 0 0, rgba(250,204,21,0.3) 0, transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(56,189,248,0.35) 0, transparent 55%);
      opacity:0.18;
      pointer-events:none;
    }
    .card:hover {
      transform:translateY(-3px);
      box-shadow:var(--shadow-strong);
      border-color:var(--accent-teal);
      background:rgba(15,23,42,0.92);
    }

    .card-header {
      display:flex;
      align-items:flex-start;
      gap:8px;
    }

    .card-title {
      font-size:14px;
      font-weight:700;
    }

    .card-count {
      margin-inline-start:auto;
      font-size:11px;
      color:var(--text-muted);
    }

    .card-subtitle {
      font-size:12px;
      color:var(--text-muted);
    }

    .card-actions {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-top:4px;
    }

    .card-status {
      font-size:11px;
      color:var(--text-muted);
      margin-top:4px;
    }

    .file-input { display:none; }

    .badge-ok { color:#4ade80 !important; }
    .badge-warn { color:#facc15 !important; }

    .footer-actions {
      margin-top:18px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .progress {
      font-size:12px;
      color:var(--text-main);
    }

    .qr-preview {
      margin-top:22px;
      background:var(--panel-soft);
      border-radius:var(--radius-xl);
      padding:14px 14px 18px;
      border:1px solid var(--border-soft);
      box-shadow:var(--shadow-soft);
    }

    .qr-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;
      margin-top:8px;
    }

    .qr-item {
      background:rgba(15,23,42,0.92);
      border-radius:16px;
      padding:10px;
      text-align:center;
      box-shadow:0 12px 32px rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.4);
    }

    .qr-item img {
      max-width:160px;
      height:auto;
      display:block;
      margin:0 auto 4px;
    }

    .small {
      font-size:11px;
      color:var(--text-muted);
      word-break:break-all;
    }

    /* Popups */
    #teacherPopup,
    #githubPopup {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.68);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:50;
      backdrop-filter:blur(8px);
    }

    .popup-inner {
      background:rgba(15,23,42,0.96);
      padding:20px 18px;
      width:320px;
      border-radius:18px;
      box-shadow:0 20px 50px rgba(0,0,0,0.8);
      border:1px solid var(--border-soft);
      color:var(--text-main);
    }

    .popup-inner h3 {
      margin:0 0 6px;
      font-size:18px;
      text-align:center;
    }

    .popup-inner p {
      margin:0 0 12px;
      font-size:12px;
      color:var(--text-muted);
      text-align:center;
    }

    .popup-input {
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.7);
      font-size:14px;
      background:rgba(15,23,42,0.9);
      color:var(--text-main);
      direction:ltr;
    }

    .popup-buttons {
      margin-top:16px;
      display:flex;
      gap:10px;
    }

    .popup-buttons button {
      flex:1;
      border:none;
      border-radius:10px;
      padding:8px 0;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
    }

    .btn-confirm {
      background:linear-gradient(135deg,var(--accent-green),var(--accent-teal));
      color:#022c22;
    }

    .btn-cancel {
      background:rgba(31,41,55,0.9);
      color:var(--text-main);
      border:1px solid rgba(148,163,184,0.6);
    }

    @media (max-width: 768px) {
      header {
        flex-direction:column;
        align-items:flex-start;
        gap:10px;
      }
      .header-spacer {
        display:none;
      }
      .footer-actions {
        flex-direction:column;
        align-items:flex-start;
      }
    }
  </style>
</head>

<body>
<div class="page">

<script>
  // التحقق من تسجيل الدخول
  (function(){
    const user = localStorage.getItem("loggedInUser");
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    window.CURRENT_USER = user;
  })();
</script>

<header>
  <div class="app-title">
    <h1>ملف إنجاز المعلم - نظام الشواهد</h1>
    <div class="app-subtitle">
      رفع شواهد المعايير، إنشاء صفحات HTML تلقائيًا على GitHub، وتوليد QR داخل ملف الإنجاز.
    </div>
    <div class="teacher-label">
      المستخدم الحالي: <span id="teacher-username"></span>
      <span id="github-status" style="margin-right:6px;font-size:10px;color:#9ca3af;"></span>
    </div>
  </div>
  <div class="header-spacer"></div>
  <button class="btn btn-ghost" id="github-btn" type="button">إعداد GitHub</button>
  <button class="btn btn-ghost" id="admin-btn" style="display:none;" type="button">لوحة التحكم</button>
  <button class="btn btn-ghost" type="button" onclick="logout()">تسجيل الخروج</button>
  <button class="btn btn-primary" type="button" id="btn-generate">توليد ملف الإنجاز النهائي</button>
</header>

<main>
  <section class="grid" id="criteria-grid"></section>

  <div class="footer-actions">
    <span class="progress" id="global-status">جارٍ تحميل القالب template.pptx...</span>
  </div>

  <section class="qr-preview" id="qr-section" style="display:none;">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <strong>معاينة رموز QR لكل معيار</strong>
      <span class="small">تم رفع صفحات HTML على GitHub وربط كل معيار برابط خاص.</span>
    </div>
    <div class="qr-grid" id="qr-grid"></div>
  </section>
</main>

<!-- Popup اسم المعلم -->
<div id="teacherPopup">
  <div class="popup-inner">
    <h3>إدخال اسم المعلم</h3>
    <p>أدخل اسم المعلم، ثم سيتم إنشاء الصفحات وملف الإنجاز تلقائيًا.</p>
    <input id="teacherNameInput" class="popup-input" style="direction:rtl;" placeholder="مثال: سعود الشريف">
    <div class="popup-buttons">
      <button class="btn-confirm" onclick="confirmTeacherName()">متابعة</button>
      <button class="btn-cancel" onclick="closeTeacherPopup()">إلغاء</button>
    </div>
  </div>
</div>

<!-- Popup إعداد GitHub -->
<div id="githubPopup">
  <div class="popup-inner">
    <h3>إعداد GitHub Token</h3>
    <p>أدخل Personal Access Token الذي لديه صلاحية الكتابة على المستودع MOE-SF فقط.</p>
    <input id="githubTokenInput" class="popup-input" placeholder="ghp_..." autocomplete="off">
    <div class="popup-buttons">
      <button class="btn-confirm" onclick="saveGithubToken()">حفظ</button>
      <button class="btn-cancel" onclick="closeGithubPopup()">إغلاق</button>
    </div>
  </div>
</div>

<script>
  // إعدادات GitHub
  const GITHUB_OWNER   = "XSF3X";
  const GITHUB_REPO    = "MOE-SF";
  const GITHUB_BRANCH  = "main";
  const GITHUB_PAGES_BASE = "https://xsf3x.github.io/MOE-SF"; // GitHub Pages base

  const PPTX_TEMPLATE_URL = "template.pptx";

  const CRITERIA = [
    { id: 1,  title: "المعيار الأول",      subtitle: "أداء الواجبات الوظيفية" },
    { id: 2,  title: "المعيار الثاني",     subtitle: "التفاعل مع المجتمع المهني" },
    { id: 3,  title: "المعيار الثالث",     subtitle: "التفاعل مع أولياء الأمور" },
    { id: 4,  title: "المعيار الرابع",     subtitle: "التنويع في إستراتيجيات التدريس" },
    { id: 5,  title: "المعيار الخامس",     subtitle: "تحسين نتائج المتعلمين" },
    { id: 6,  title: "المعيار السادس",     subtitle: "إعداد وتنفيذ خطة التعلم" },
    { id: 7,  title: "المعيار السابع",     subtitle: "توظيف تقنيات ووسائل التعلم المناسبة" },
    { id: 8,  title: "المعيار الثامن",     subtitle: "تهيئة البيئة التعليمية" },
    { id: 9,  title: "المعيار التاسع",     subtitle: "الإدارة الصفية" },
    { id: 10, title: "المعيار العاشر",     subtitle: "تحليل نتائج المتعلمين وتشخيص مستوياتهم" },
    { id: 11, title: "المعيار الحادي عشر", subtitle: "تنوع أساليب وأدوات التقويم" },
    { id: 12, title: "منجزات أخرى",        subtitle: "منجزات أخرى خلال العام الدراسي ١٤٤٧ هـ" }
  ];

  const state = {
    pptxBuffer: null,
    criteriaFiles: {},   // {id: File[]}
    albums: {},          // {id: {...}}
    teacherName: "",
    githubToken: localStorage.getItem("githubToken") || ""
  };

  const gridEl = document.getElementById("criteria-grid");
  const globalStatusEl = document.getElementById("global-status");
  const btnGenerate = document.getElementById("btn-generate");
  const qrSection = document.getElementById("qr-section");
  const qrGrid = document.getElementById("qr-grid");
  const teacherUsernameSpan = document.getElementById("teacher-username");
  const adminBtn = document.getElementById("admin-btn");
  const githubBtn = document.getElementById("github-btn");
  const githubStatus = document.getElementById("github-status");

  if (window.CURRENT_USER && teacherUsernameSpan) {
    teacherUsernameSpan.textContent = window.CURRENT_USER;
  }

  if (adminBtn) {
    adminBtn.addEventListener("click", () => {
      window.location.href = "admin.html";
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    if (adminBtn) {
      adminBtn.style.display = (window.CURRENT_USER === "admin") ? "inline-flex" : "none";
    }
    updateGithubStatus();
  });

  function logout() {
    localStorage.removeItem("loggedInUser");
    window.location.href = "login.html";
  }

  function updateGithubStatus() {
    if (!githubStatus) return;
    if (state.githubToken) {
      githubStatus.textContent = "GitHub Token مضبوط.";
    } else {
      githubStatus.textContent = "لم يتم إعداد GitHub Token بعد.";
    }
  }

  // ========= GitHub Token Popup =========
  githubBtn.addEventListener("click", () => {
    document.getElementById("githubTokenInput").value = state.githubToken;
    document.getElementById("githubPopup").style.display = "flex";
  });

  function closeGithubPopup() {
    document.getElementById("githubPopup").style.display = "none";
  }

  function saveGithubToken() {
    const val = document.getElementById("githubTokenInput").value.trim();
    if (!val) {
      alert("لن يتم الحفظ بدون Token.");
      return;
    }
    state.githubToken = val;
    localStorage.setItem("githubToken", val);
    updateGithubStatus();
    closeGithubPopup();
  }

  // ========= Helpers =========

  function slugifyTeacher(name) {
    return name.trim()
      .replace(/\s+/g, "-")
      .replace(/[^\w\u0600-\u06FF-]/g, "");
  }

  function buildHtmlFileName(teacherName, criterionId) {
    const slug = slugifyTeacher(teacherName) || "teacher";
    const idStr = String(criterionId).padStart(2, "0");
    return `albums/${slug}_c${idStr}.html`;
  }

  function buildHtmlPageUrl(path) {
    const base = GITHUB_PAGES_BASE.replace(/\/$/, "");
    return `${base}/${path}`;
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  function buildCriterionHtml({ teacherName, criterion, images }) {
    const safeTeacher = escapeHtml(teacherName);
    const safeTitle   = escapeHtml(criterion.title);
    const safeSub     = escapeHtml(criterion.subtitle);

    const imgsHtml = images.map(src => `
      <div class="img-card">
        <img src="${src}" loading="lazy">
      </div>
    `).join("\n");

    return `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>شواهد ${safeTitle} - ${safeTeacher}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #020617;
      --panel: #0f172a;
      --accent: #22c55e;
      --accent-soft: rgba(34,197,94,0.12);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border: rgba(148,163,184,0.42);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 0 0,#22c55e20,transparent 55%),
                  radial-gradient(circle at 100% 100%,#6366f120,transparent 55%),
                  var(--bg);
      color: var(--text-main);
      min-height: 100vh;
      padding: 18px 12px 28px;
    }
    .wrap {
      max-width: 960px;
      margin: 0 auto;
    }
    header {
      background: linear-gradient(135deg,#0f172a,#020617);
      border-radius: 18px;
      padding: 16px 18px 14px;
      border: 1px solid var(--border);
      box-shadow: 0 16px 40px rgba(15,23,42,0.9);
      margin-bottom: 18px;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 18px;
    }
    .meta {
      font-size: 13px;
      color: var(--text-muted);
    }
    .badge {
      display: inline-block;
      margin-top: 10px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: #bbf7d0;
      font-size: 12px;
      border: 1px solid rgba(34,197,94,0.35);
    }
    .imgs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap: 12px;
    }
    .img-card {
      background: #020617;
      border-radius: 16px;
      padding: 8px;
      border: 1px solid var(--border);
      box-shadow: 0 14px 35px rgba(15,23,42,0.85);
    }
    img {
      width: 100%;
      height: auto;
      border-radius: 10px;
      display:block;
    }
    footer {
      margin-top: 18px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>شواهد ${safeTitle}</h1>
      <div class="meta">
        المعلم: ${safeTeacher}<br>
        ${safeSub}
      </div>
      <div class="badge">صفحة شواهد تفاعلية - ملف الإنجاز</div>
    </header>
    <section class="imgs-grid">
      ${imgsHtml}
    </section>
    <footer>
      هذه الصفحة جزء من ملف إنجاز المعلم، تم إنشاؤها تلقائيًا من نظام الشواهد.
    </footer>
  </div>
</body>
</html>`;
  }

  // UTF-8 → Base64
  function utf8ToBase64(str) {
    const encoder = new TextEncoder();
    const bytes = encoder.encode(str);
    let binary = "";
    const chunkSize = 0x8000;
    for (let i = 0; i < bytes.length; i += chunkSize) {
      const sub = bytes.subarray(i, i + chunkSize);
      binary += String.fromCharCode.apply(null, sub);
    }
    return btoa(binary);
  }

  async function uploadFileToGitHub(path, content) {
    if (!state.githubToken) {
      throw new Error("GitHub Token غير مضبوط.");
    }
    const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(path)}`;
    const headers = {
      "Authorization": `Bearer ${state.githubToken}`,
      "Accept": "application/vnd.github+json"
    };

    // جلب sha لو الملف موجود
    let sha = null;
    try {
      const getRes = await fetch(url, { headers });
      if (getRes.ok) {
        const j = await getRes.json();
        sha = j.sha;
      }
    } catch (e) {
      console.warn("GET sha error:", e);
    }

    const body = {
      message: `chore: update auto-generated album ${path}`,
      content: utf8ToBase64(content),
      branch: GITHUB_BRANCH
    };
    if (sha) body.sha = sha;

    const putRes = await fetch(url, {
      method: "PUT",
      headers,
      body: JSON.stringify(body)
    });

    if (!putRes.ok) {
      const txt = await putRes.text();
      throw new Error(`GitHub upload failed (${putRes.status}): ${txt}`);
    }

    return putRes.json();
  }

  function dataURLToUint8Array(dataURL) {
    const base64 = dataURL.split(",")[1];
    const binaryStr = atob(base64);
    const len = binaryStr.length;
    const bytes = new Uint8Array(len);
    for (let i=0;i<len;i++) bytes[i] = binaryStr.charCodeAt(i);
    return bytes;
  }

  function generateQRBinary(url) {
    return new Promise((resolve,reject) => {
      const tmpDiv = document.createElement("div");
      tmpDiv.style.position = "absolute";
      tmpDiv.style.left = "-9999px";
      tmpDiv.style.top = "-9999px";
      document.body.appendChild(tmpDiv);

      const qr = new QRCode(tmpDiv, {
        text: url,
        width: 200,
        height: 200,
        correctLevel: QRCode.CorrectLevel.L,
        margin: 1
      });

      setTimeout(() => {
        const canvas = tmpDiv.querySelector("canvas");
        if (!canvas) {
          document.body.removeChild(tmpDiv);
          reject(new Error("فشل توليد QR"));
          return;
        }
        const dataURL = canvas.toDataURL("image/png");
        const bytes = dataURLToUint8Array(dataURL);
        document.body.removeChild(tmpDiv);
        resolve({ dataURL, bytes });
      }, 400);
    });
  }

  async function fileToDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function replaceTeacherName(zip, name) {
    const slide1 = "ppt/slides/slide1.xml";
    if (!zip.file(slide1)) return;
    let xml = await zip.file(slide1).async("string");
    xml = xml.replace(/∑/g, name);
    zip.file(slide1, xml);
  }

  async function injectQROnPptx(zip, albums) {
    const ctFile = zip.file("[Content_Types].xml");
    if (ctFile) {
      let ct = await ctFile.async("string");
      if (!ct.includes('image/png')) {
        const pos = ct.lastIndexOf("</Types>");
        const defPng = '<Default Extension="png" ContentType="image/png"/>';
        ct = ct.slice(0,pos) + defPng + ct.slice(pos);
        zip.file("[Content_Types].xml", ct);
      }
    }

    zip.folder("ppt")?.folder("media") || zip.folder("ppt").folder("media");

    const critIds = Object.keys(albums).map(Number).sort((a,b)=>a-b);
    for (const id of critIds) {
      const mediaName = `image_qr_${id}.png`;
      albums[id].mediaName = mediaName;
      zip.file(`ppt/media/${mediaName}`, albums[id].qrBinary, { binary:true });
    }

    const slidePaths = Object.keys(zip.files)
      .filter(p => p.startsWith("ppt/slides/slide") && p.endsWith(".xml"))
      .sort((a,b) => {
        const na = parseInt(a.match(/slide(\d+)\.xml/)[1],10);
        const nb = parseInt(b.match(/slide(\d+)\.xml/)[1],10);
        return na - nb;
      });

    let critPtr = 0;

    for (const slidePath of slidePaths) {
      let xml = await zip.file(slidePath).async("string");
      const slideBase = slidePath.split("/").pop();
      const relsPath = `ppt/slides/_rels/${slideBase}.rels`;

      let relsXml;
      if (zip.file(relsPath)) {
        relsXml =
          await zip.file(relsPath).async("string");
      } else {
        relsXml =
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"></Relationships>`;
      }

      let maxRid = 1;
      const ridRegex = /Id="rId(\d+)"/g;
      let m;
      while ((m = ridRegex.exec(relsXml)) !== null) {
        const n = parseInt(m[1],10);
        if (!isNaN(n) && n > maxRid) maxRid = n;
      }

      let curIndex = 0;
      let changed = false;

      while (true) {
        const start = xml.indexOf("<p:sp", curIndex);
        if (start === -1) break;
        const end = xml.indexOf("</p:sp>", start);
        if (end === -1) break;
        const blockEnd = end + "</p:sp>".length;
        const block = xml.slice(start, blockEnd);

        if (block.includes('a:srgbClr') && block.includes('FF00FF') && critPtr < critIds.length) {
          const critId = critIds[critPtr++];
          const mediaName = albums[critId].mediaName;

          let spPr = "";
          const spStart = block.indexOf("<p:spPr");
          if (spStart !== -1) {
            const spEnd = block.indexOf("</p:spPr>", spStart);
            if (spEnd !== -1) {
              spPr = block.slice(spStart, spEnd + "</p:spPr>".length);
            }
          }
          if (!spPr) spPr = "<p:spPr/>";

          const newRid = "rId" + (++maxRid);
          const picXml =
            `<p:pic>` +
              `<p:nvPicPr>` +
                `<p:cNvPr id="${1000 + critId}" name="QR ${critId}"/>` +
                `<p:cNvPicPr/>` +
                `<p:nvPr/>` +
              `</p:nvPicPr>` +
              `<p:blipFill>` +
                `<a:blip r:embed="${newRid}"/>` +
                `<a:stretch><a:fillRect/></a:stretch>` +
              `</p:blipFill>` +
              spPr +
            `</p:pic>`;

          xml = xml.slice(0,start) + picXml + xml.slice(blockEnd);

          const insertPos = relsXml.lastIndexOf("</Relationships>");
          const relLine =
            `<Relationship Id="${newRid}" ` +
            `Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" ` +
            `Target="../media/${mediaName}"/>`;
          relsXml = relsXml.slice(0,insertPos) + relLine + relsXml.slice(insertPos);

          curIndex = start + picXml.length;
          changed = true;
        } else {
          curIndex = blockEnd;
        }
      }

      if (changed) {
        zip.file(slidePath, xml);
        zip.file(relsPath, relsXml);
      }
    }
  }

  // ========= UI لبناء بطاقات المعايير =========

  function buildCards() {
    CRITERIA.forEach(crit => {
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.criterionId = crit.id;

      const header = document.createElement("div");
      header.className = "card-header";

      const titleEl = document.createElement("div");
      titleEl.className = "card-title";
      titleEl.textContent = crit.title;

      const countEl = document.createElement("div");
      countEl.className = "card-count";
      countEl.id = `count-${crit.id}`;
      countEl.textContent = "0 صورة";

      header.appendChild(titleEl);
      header.appendChild(countEl);

      const subtitleEl = document.createElement("div");
      subtitleEl.className = "card-subtitle";
      subtitleEl.textContent = crit.subtitle;

      const actions = document.createElement("div");
      actions.className = "card-actions";

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.multiple = true;
      fileInput.accept = "image/*";
      fileInput.className = "file-input";
      fileInput.id = `files-${crit.id}`;

      const btnSelect = document.createElement("button");
      btnSelect.type = "button";
      btnSelect.className = "btn btn-ghost";
      btnSelect.textContent = "اختيار صور الشواهد";
      btnSelect.addEventListener("click", () => fileInput.click());

      fileInput.addEventListener("change", () => {
        const files = Array.from(fileInput.files || []);
        state.criteriaFiles[crit.id] = files;
        countEl.textContent = `${files.length} صورة`;
        const statusEl = document.getElementById(`status-${crit.id}`);
        if (files.length > 0) {
          statusEl.textContent = "سيتم إنشاء صفحة HTML ورفعها لهذا المعيار.";
          statusEl.classList.add("badge-ok");
          statusEl.classList.remove("badge-warn");
        } else {
          statusEl.textContent = "لم يتم اختيار أي صورة.";
          statusEl.classList.remove("badge-ok","badge-warn");
        }
      });

      const statusText = document.createElement("div");
      statusText.className = "card-status";
      statusText.id = `status-${crit.id}`;
      statusText.textContent = "لم يتم اختيار أي صورة.";

      actions.appendChild(btnSelect);

      card.appendChild(header);
      card.appendChild(subtitleEl);
      card.appendChild(actions);
      card.appendChild(statusText);
      card.appendChild(fileInput);

      gridEl.appendChild(card);
    });
  }

  async function loadTemplate() {
    try {
      const res = await fetch(PPTX_TEMPLATE_URL);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const buf = await res.arrayBuffer();
      state.pptxBuffer = buf;
      globalStatusEl.textContent = "القالب template.pptx جاهز. اختر الصور ثم اضغط توليد الملف.";
    } catch (e) {
      console.error(e);
      globalStatusEl.textContent = "تعذر تحميل القالب template.pptx. تأكد أنه موجود بجانب index.html.";
    }
  }

  // ========= منطق التوليد الكامل =========

  async function generateAndDownload() {
    if (!state.pptxBuffer) {
      alert("القالب template.pptx غير محمّل. تأكد من وجوده.");
      return;
    }

    if (!state.githubToken) {
      alert("الرجاء إعداد GitHub Token أولًا من زر 'إعداد GitHub'.");
      return;
    }

    const activeCriteria = CRITERIA.filter(c => (state.criteriaFiles[c.id] || []).length > 0);
    if (activeCriteria.length === 0) {
      alert("لم يتم اختيار أي صور لأي معيار.");
      return;
    }

    if (!state.teacherName) {
      alert("اسم المعلم غير مضبوط.");
      return;
    }

    btnGenerate.disabled = true;
    globalStatusEl.textContent = "جارٍ إنشاء صفحات HTML ورفعها على GitHub...";
    qrGrid.innerHTML = "";
    qrSection.style.display = "none";
    state.albums = {};

    let critIndex = 0;

    for (const crit of activeCriteria) {
      critIndex++;
      const files = state.criteriaFiles[crit.id] || [];
      const statusEl = document.getElementById(`status-${crit.id}`);

      statusEl.textContent = `معالجة صور هذا المعيار (${files.length} صورة)...`;
      statusEl.classList.remove("badge-ok","badge-warn");

      const dataUrls = [];
      let fileIndex = 0;
      for (const f of files) {
        fileIndex++;
        globalStatusEl.textContent =
          `معيار ${critIndex}/${activeCriteria.length} - صورة ${fileIndex}/${files.length} (${crit.title})...`;
        try {
    const durl = await fileToDataURL(f);
    if (!durl || typeof durl !== "string" || !durl.startsWith("data:image")) {
        console.warn("Bad image skipped:", f.name);
        continue;
    }
    dataUrls.push(durl);
} catch (err) {
    console.error("Failed to read file:", f.name, err);
    continue;
}


      if (dataUrls.length === 0) {
        statusEl.textContent = "لم يتم تحويل أي صورة بنجاح لهذا المعيار.";
        statusEl.classList.add("badge-warn");
        continue;
      }

      const htmlPath = buildHtmlFileName(state.teacherName, crit.id);
      const pageHtml = buildCriterionHtml({
        teacherName: state.teacherName,
        criterion: crit,
        images: dataUrls
      });

      globalStatusEl.textContent = `رفع صفحة HTML إلى GitHub (${htmlPath})...`;
      try {
        await uploadFileToGitHub(htmlPath, pageHtml);
      } catch (e) {
        console.error(e);
        statusEl.textContent = "خطأ أثناء رفع صفحة HTML إلى GitHub لهذا المعيار.";
        statusEl.classList.add("badge-warn");
        continue;
      }

      const pageUrl = buildHtmlPageUrl(htmlPath);
      const qrInfo = await generateQRBinary(pageUrl);

      state.albums[crit.id] = {
        htmlPath,
        pageHtml,
        pageUrl,
        qrBinary: qrInfo.bytes,
        qrDataURL: qrInfo.dataURL
      };

      const qrItem = document.createElement("div");
      qrItem.className = "qr-item";
      const t = document.createElement("div");
      t.style.fontSize = "13px";
      t.style.marginBottom = "4px";
      t.textContent = crit.title;
      qrItem.appendChild(t);

      const imgEl = document.createElement("img");
      imgEl.src = qrInfo.dataURL;
      qrItem.appendChild(imgEl);

      const small = document.createElement("div");
      small.className = "small";
      small.textContent = "الرابط: " + pageUrl;
      qrItem.appendChild(small);

      qrGrid.appendChild(qrItem);

      statusEl.textContent = "تم إنشاء صفحة HTML ورفعها وربطها بـ QR.";
      statusEl.classList.add("badge-ok");
    }

    const albumIds = Object.keys(state.albums).map(Number);
    if (albumIds.length === 0) {
      globalStatusEl.textContent = "لم تنجح عملية رفع الصفحات لأي معيار.";
      btnGenerate.disabled = false;
      return;
    }

    qrSection.style.display = "block";
    globalStatusEl.textContent = "جارٍ تعديل ملف PPTX ودمج اسم المعلم و QR...";

    try {
      const arrayBuffer = state.pptxBuffer.slice(0);
      const zip = await JSZip.loadAsync(arrayBuffer);

      await replaceTeacherName(zip, state.teacherName);
      await injectQROnPptx(zip, state.albums);

      const blob = await zip.generateAsync({ type:"blob" });
      const pptxName = "ملف إنجاز المعلم_QR_ready.pptx";
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = pptxName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      globalStatusEl.textContent =
        "تم إنشاء ملف الإنجاز النهائي، وتم رفع صفحات HTML وربطها بالـ QR داخل الشرائح.";
    } catch (e) {
      console.error(e);
      globalStatusEl.textContent = "حدث خطأ أثناء تعديل ملف PPTX.";
      alert("حدث خطأ أثناء التوليد. راجع الكونسول للتفاصيل.");
    }

    btnGenerate.disabled = false;
  }

  // ========= Popups =========

  function openTeacherPopup() {
    document.getElementById("teacherNameInput").value = "";
    document.getElementById("teacherPopup").style.display = "flex";
  }
  function closeTeacherPopup() {
    document.getElementById("teacherPopup").style.display = "none";
  }
  function confirmTeacherName() {
    const val = document.getElementById("teacherNameInput").value.trim();
    if (!val) {
      alert("الرجاء إدخال اسم المعلم.");
      return;
    }
    state.teacherName = val;
    closeTeacherPopup();
    generateAndDownload();
  }

  btnGenerate.addEventListener("click", () => {
    openTeacherPopup();
  });

  // تشغيل أولي
  buildCards();
  loadTemplate();
</script>

</div>
</body>
</html>
