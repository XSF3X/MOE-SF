<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ - Ù…Ù„Ù Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg:#0f172a;
  --fg:#e2e8f0;
  --panel:#1e293b;
  --accent:#3b82f6;
  --border:#334155;
}

body {
  margin:0; padding:0;
  background:var(--bg);
  color:var(--fg);
  font-family:'Tajawal',sans-serif;
}

header {
  background:var(--panel);
  padding:16px;
  text-align:center;
  font-size:22px;
  border-bottom:1px solid var(--border);
}

.container {
  max-width:1200px;
  margin:20px auto;
  padding:16px;
}

.criteria-box {
  background:var(--panel);
  margin-bottom:20px;
  padding:14px;
  border:1px solid var(--border);
  border-radius:14px;
}

.criteria-title {
  font-size:20px;
  margin-bottom:6px;
}

.criteria-subtitle {
  font-size:14px;
  margin-bottom:12px;
  color:#94a3b8;
}

.upload-area {
  border:2px dashed var(--border);
  border-radius:12px;
  padding:20px;
  text-align:center;
  cursor:pointer;
  color:#94a3b8;
  margin-bottom:14px;
}

.thumbs {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

.thumbs img {
  width:110px;
  height:110px;
  object-fit:cover;
  border-radius:10px;
  border:1px solid var(--border);
}

.generate-btn {
  margin-top:30px;
  display:block;
  width:100%;
  padding:14px;
  border-radius:12px;
  background:var(--accent);
  border:none;
  color:white;
  font-size:18px;
  cursor:pointer;
}

.loading {
  display:none;
  margin-top:10px;
  padding:12px;
  background:var(--panel);
  border-radius:10px;
  text-align:center;
  border:1px solid var(--border);
  color:#a5b4fc;
}

.popup-overlay {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(15,23,42,0.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.popup-box {
  background:var(--panel);
  width:380px;
  padding:20px;
  border-radius:16px;
  border:1px solid var(--border);
}

.popup-box h3 {
  margin:0 0 12px;
}

.popup-box input {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#0f172a;
  color:var(--fg);
  margin-bottom:16px;
  font-size:16px;
}

.popup-box button {
  width:100%;
  padding:12px;
  font-size:17px;
  background:var(--accent);
  color:white;
  border:none;
  border-radius:10px;
  cursor:pointer;
}
</style>

</head>
<body>

<header>ğŸ“ Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø´ÙˆØ§Ù‡Ø¯ Ù…Ù„Ù Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</header>

<div class="container" id="criteriaContainer"></div>

<button class="generate-btn" onclick="startGeneration()">ğŸš€ ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</button>
<div class="loading" id="loadingBox">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±â€¦</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… -->
<div class="popup-overlay" id="teacherPopup">
  <div class="popup-box">
    <h3>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
    <input id="teacherNameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
    <button onclick="confirmTeacherName()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
  </div>
</div>

<script>
const CLOUD_NAME = "dayqxxloc";
const UPLOAD_PRESET = "saud_preset";

const CRITERIA = [
  {id:1,title:"Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„",subtitle:"Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ©"},
  {id:2,title:"Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ",subtitle:"Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ù…Ù‡Ù†ÙŠ"},
  {id:3,title:"Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«",subtitle:"Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±"},
  {id:4,title:"Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹",subtitle:"Ø§Ù„ØªÙ†ÙˆÙŠØ¹ ÙÙŠ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³"},
  {id:5,title:"Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø®Ø§Ù…Ø³",subtitle:"ØªØ­Ø³ÙŠÙ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ†"},
  {id:6,title:"Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¯Ø³",subtitle:"Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªÙ†ÙÙŠØ° Ø®Ø·Ø© Ø§Ù„ØªØ¹Ù„Ù…"},
  {id:7,title:"Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¨Ø¹",subtitle:"ØªÙˆØ¸ÙŠÙ ØªÙ‚Ù†ÙŠØ§Øª ÙˆÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ¹Ù„Ù…"},
  {id:8,title:"Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù…Ù†",subtitle:"ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©"},
  {id:9,title:"Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„ØªØ§Ø³Ø¹",subtitle:"Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙŠØ©"},
  {id:10,title:"Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ø´Ø±",subtitle:"ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª"},
  {id:11,title:"Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±",subtitle:"ØªÙ†ÙˆØ¹ Ø£Ø³Ø§Ù„ÙŠØ¨ ÙˆØ£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ…"},
  {id:12,title:"Ù…Ù†Ø¬Ø²Ø§Øª Ø£Ø®Ø±Ù‰",subtitle:"Ù…Ù†Ø¬Ø²Ø§Øª Ø£Ø®Ø±Ù‰ Ø®Ù„Ø§Ù„ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 1447 Ù‡Ù€"}
];

const state = {
  teacherName:"",
  files:{} // {1:[..],2:[..]}
};

function buildUI(){
  const c = document.getElementById("criteriaContainer");
  c.innerHTML="";
  CRITERIA.forEach(k=>{
    c.innerHTML+=`
      <div class="criteria-box">
        <div class="criteria-title">${k.title}</div>
        <div class="criteria-subtitle">${k.subtitle}</div>

        <div class="upload-area" onclick="pickFiles(${k.id})">
          Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø´ÙˆØ§Ù‡Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±
        </div>

        <div class="thumbs" id="thumbs${k.id}"></div>
      </div>
    `;
  });
}

function pickFiles(id){
  const i=document.createElement("input");
  i.type="file";
  i.multiple=true;
  i.accept="image/*";
  i.onchange=()=>{
    const files=[...i.files];
    if(!state.files[id]) state.files[id]=[];
    state.files[id].push(...files);
    renderThumbs(id);
  };
  i.click();
}

function renderThumbs(id){
  const div=document.getElementById("thumbs"+id);
  div.innerHTML="";
  (state.files[id]||[]).forEach(f=>{
    const url=URL.createObjectURL(f);
    div.innerHTML+=`<img src="${url}">`;
  });
}

function startGeneration(){
  document.getElementById("teacherPopup").style.display="flex";
}

function confirmTeacherName(){
  const name=document.getElementById("teacherNameInput").value.trim();
  if(!name){ alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…"); return; }
  state.teacherName=name;
  document.getElementById("teacherPopup").style.display="none";
  generate();
}

async function uploadSingleFile(file){
  const url=`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
  const fd=new FormData();
  fd.append("file",file);
  fd.append("upload_preset",UPLOAD_PRESET);

  const r=await fetch(url,{method:"POST",body:fd});
  if(!r.ok){throw new Error("Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙØ´Ù„");}
  const j=await r.json();
  return j.secure_url;
}
// Ø¨Ù†Ø§Ø¡ ØµÙØ­Ø© HTML Ù„Ø´ÙˆØ§Ù‡Ø¯ Ù…Ø¹ÙŠØ§Ø± ÙˆØ§Ø­Ø¯
function buildCriterionHtml(teacherName, crit, imageUrls){
  const esc = s => String(s||"")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");

  const title = esc(crit.title);
  const subtitle = esc(crit.subtitle);
  const tName = esc(teacherName);

  const imgs = imageUrls.map(u=>`
    <div class="img-box">
      <img src="${u}" alt="Ø´Ø§Ù‡Ø¯">
    </div>
  `).join("\n");

  return `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>${title} - ${tName}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  margin:0; padding:16px;
  background:#0f172a; color:#e5e7eb;
  font-family:'Tajawal',sans-serif;
}
.wrap { max-width:900px; margin:auto; }
h1 { font-size:24px; margin:0 0 6px; }
h2 { font-size:16px; margin:0 0 16px; color:#94a3b8; }
.meta { font-size:13px; color:#9ca3af; margin-bottom:16px; }
.grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
  gap:12px;
}
.img-box {
  background:#1e293b;
  border-radius:12px; padding:6px;
  border:1px solid #334155;
}
.img-box img {
  width:100%;
  border-radius:10px;
  max-height:500px;
  object-fit:contain;
}
</style>
</head>
<body>
<div class="wrap">
  <h1>${title}</h1>
  <h2>${subtitle}</h2>
  <div class="meta">Ø§Ù„Ù…Ø¹Ù„Ù…: ${tName}</div>
  <div class="grid">
    ${imgs}
  </div>
</div>
</body>
</html>
`;
}

// Ø±ÙØ¹ ØµÙØ­Ø© HTML Ø¥Ù„Ù‰ GitHub Pages Ø¹Ø¨Ø± API
async function uploadHtmlToGithub(filename, content){
  const token = localStorage.getItem("GITHUB_TOKEN");
  if(!token){
    throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ GitHub Token Ù…Ø®Ø²Ù†");
  }

  const repo = "XSF3X/MOE-SF";
  const url = `https://api.github.com/repos/${repo}/contents/evidence/${filename}`;

  // ØªØ´ÙÙŠØ± Base64
  const encoded = btoa(unescape(encodeURIComponent(content)));

  // ÙØ­Øµ Ù‡Ù„ Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ Ø³Ø§Ø¨Ù‚Ø§Ù‹ (Ù„ÙƒÙŠ Ù†Ø±Ø³Ù„ sha)
  let sha = null;
  const check = await fetch(url);
  if(check.ok){
    const data = await check.json();
    sha = data.sha;
  }

  const body = {
    message: "Update evidence file",
    content: encoded,
  };
  if(sha) body.sha = sha;

  const res = await fetch(url,{
    method:"PUT",
    headers:{
      "Authorization":"token "+token,
      "Content-Type":"application/json"
    },
    body:JSON.stringify(body)
  });

  if(!res.ok){
    throw new Error("Ø±ÙØ¹ HTML Ø¥Ù„Ù‰ GitHub ÙØ´Ù„");
  }

  return `https://xsf3x.github.io/MOE-SF/evidence/${filename}`;
}

// Ø¥Ù†Ø´Ø§Ø¡ QR ÙƒØµÙˆØ±Ø© Base64
function generateQR(text){
  return new Promise((resolve,reject)=>{
    QRCode.toDataURL(text,{errorCorrectionLevel:"L",margin:0,scale:6},(err,url)=>{
      if(err) reject(err);
      else resolve(url);
    });
  });
}

async function generate(){
  document.getElementById("loadingBox").style.display="block";

  const ppt = new PptxGenJS();
  ppt.layout = "LAYOUT_WIDE";

  // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¨ÙˆØ±Ø¨ÙˆÙŠÙ†Øª
  const resp = await fetch("template.pptx");
  const buf = await resp.arrayBuffer();
  ppt.load(buf);

  for(const crit of CRITERIA){
    const files = state.files[crit.id] || [];
    if(files.length === 0) continue;

    // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± â†’ Cloudinary
    const urls = [];
    for(const f of files){
      const u = await uploadSingleFile(f);
      urls.push(u);
    }

    // Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© HTML
    const html = buildCriterionHtml(state.teacherName, crit, urls);
    const filename = `c${crit.id}.html`;

    // Ø±ÙØ¹ HTML Ø¥Ù„Ù‰ GitHub Pages
    const htmlUrl = await uploadHtmlToGithub(filename, html);

    // ØªÙˆÙ„ÙŠØ¯ QR
    const qr = await generateQR(htmlUrl);

    // Ø¯Ù…Ø¬ QR ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ­Ø©
    const slide = ppt.slides[crit.id];
    if(slide){
      slide.addImage({
        data: qr,
        x: 1.0, y: 1.3,
        w: 2.8, h: 2.8
      });
    }
  }

  ppt.writeFile({fileName:`Ù…Ù„Ù Ø¥Ù†Ø¬Ø§Ø² - ${state.teacherName}.pptx`});

  document.getElementById("loadingBox").style.display="none";
}

// --- ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
buildUI();
</script>

<!-- Ù…ÙƒØªØ¨Ø§Øª QR + PPTX -->
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.11.0/dist/pptxgen.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

</body>
</html>
